# CPR-TaG-Net å®Œæ•´è®­ç»ƒPipelineä½¿ç”¨æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä»è‚ºåŠ¨è„‰åˆ†å‰²æ ‡ç­¾åˆ°è¡€ç®¡åˆ†ç±»çš„å®Œæ•´pipelineï¼ŒåŒ…æ‹¬ï¼š
1. æ ‡ç­¾è¿‡æ»¤å’Œé¢„å¤„ç†
2. ä¸­å¿ƒçº¿æå–å’Œå›¾æ„å»º
3. CPR-TaG-Netè®­ç»ƒå’Œæ¨ç†

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
/Users/leslie/IT/feixueguanditu/test/
â”œâ”€â”€ train/                          # CTå›¾åƒç›®å½• (.niiæ–‡ä»¶)
â”œâ”€â”€ label/                          # åŸå§‹åˆ†å‰²æ ‡ç­¾
â”œâ”€â”€ label_filtered/                 # è¿‡æ»¤åçš„æ ‡ç­¾ (å·²å®Œæˆ)
â”œâ”€â”€ keep.txt                        # ä¿ç•™æ ‡ç­¾åˆ—è¡¨
â”œâ”€â”€ CPR_TaG_Net/                    # CPR-TaG-Netæ¨¡å‹ä»£ç 
â”‚   â””â”€â”€ models/
â”‚       â”œâ”€â”€ cpr_tagnet.py          # ä¸»æ¨¡å‹
â”‚       â””â”€â”€ modules/               # æ¨¡å‹ç»„ä»¶
â”œâ”€â”€ vessel_preprocessing.py         # æ•°æ®é¢„å¤„ç†è„šæœ¬
â”œâ”€â”€ data_loader.py                 # æ•°æ®åŠ è½½å™¨
â”œâ”€â”€ train_pipeline.py              # å®Œæ•´è®­ç»ƒpipeline
â””â”€â”€ processed_data/                # å¤„ç†åçš„è®­ç»ƒæ•°æ® (å°†ç”Ÿæˆ)
```

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### å¿…éœ€ä¾èµ–
```bash
pip install SimpleITK numpy scipy scikit-image scikit-learn networkx
pip install torch torchvision torch-geometric  # PyTorchç›¸å…³
pip install tqdm tensorboard  # è®­ç»ƒç›¸å…³
```

### å¯é€‰ä¾èµ–ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
```bash
pip install vtk  # 3Då¯è§†åŒ–
pip install matplotlib seaborn  # ç»˜å›¾
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ•°æ®é¢„å¤„ç† (å¿…éœ€)

é¦–å…ˆéœ€è¦å®‰è£…ä¾èµ–å¹¶è¿è¡Œé¢„å¤„ç†ï¼š

```bash
# å®‰è£…å¿…éœ€çš„ä¾èµ–åŒ…
pip install SimpleITK numpy scipy scikit-image scikit-learn networkx

# è¿è¡Œæ•°æ®é¢„å¤„ç†ï¼ˆä»…é¢„å¤„ç†ï¼Œä¸è®­ç»ƒï¼‰
python train_pipeline.py --preprocess_only
```

é¢„å¤„ç†è¿‡ç¨‹åŒ…æ‹¬ï¼š
- âœ… ä»è¿‡æ»¤åçš„æ ‡ç­¾ä¸­æå–è¡€ç®¡ä¸­å¿ƒçº¿
- âœ… æ„å»ºè¡€ç®¡æ‹“æ‰‘å›¾ç»“æ„
- âœ… é‡‡æ ·èŠ‚ç‚¹å‘¨å›´çš„3Då›¾åƒå—
- âœ… è®¡ç®—54ç»´å‡ ä½•ç‰¹å¾
- âœ… ç”Ÿæˆè®­ç»ƒæ•°æ®

### 2. æ¨¡å‹è®­ç»ƒ (éœ€è¦PyTorch)

å¦‚æœå·²å®‰è£…PyTorchç¯å¢ƒï¼š

```bash
# å®‰è£…PyTorchä¾èµ–
pip install torch torchvision torch-geometric tqdm tensorboard

# è¿è¡Œå®Œæ•´è®­ç»ƒpipeline
python train_pipeline.py --epochs 50 --batch_size 2
```

## ğŸ“Š æ•°æ®é¢„å¤„ç†è¯¦è§£

### è¾“å…¥æ•°æ®
- **CTå›¾åƒ**: `train/` ç›®å½•ä¸‹çš„ `.nii` æ–‡ä»¶
- **åˆ†å‰²æ ‡ç­¾**: `label_filtered/` ç›®å½•ä¸‹çš„ `.seg.nrrd` æ–‡ä»¶ (24ä¸ªæ–‡ä»¶)
- **æ ‡ç­¾æ˜ å°„**: 15ä¸ªå‰ä¸‰çº§è‚ºåŠ¨è„‰è¡€ç®¡æ ‡ç­¾

### å¤„ç†æµç¨‹

#### 1. ä¸­å¿ƒçº¿æå–
```python
# å¯¹æ¯ä¸ªè¡€ç®¡æ ‡ç­¾ï¼š
# 1. å½¢æ€å­¦æ¸…ç† -> 2. 3Déª¨æ¶åŒ– -> 3. ä¸­å¿ƒçº¿æ’åº -> 4. åŠå¾„ä¼°è®¡
vessel_mask -> skeleton_3d -> ordered_centerline -> radii
```

#### 2. å‡ ä½•ç‰¹å¾è®¡ç®— (54ç»´)
```
åæ ‡ (3) + åŠå¾„ (1) + æ–¹å‘ (3) + æ›²ç‡ (1) + æ‰­è½¬ (1) + 
å±€éƒ¨ç»Ÿè®¡ (6) + è·ç¦»ç‰¹å¾ (6) + åˆ†å‰ç‰¹å¾ (3) + ä½ç½®ç¼–ç  (30) = 54ç»´
```

#### 3. å›¾æ„å»º
```python
# èŠ‚ç‚¹ï¼šä¸­å¿ƒçº¿é‡‡æ ·ç‚¹
# è¾¹ï¼šè¡€ç®¡å†…è¿æ¥ + è§£å‰–å­¦è¿æ¥
# ç‰¹å¾ï¼š54ç»´å‡ ä½•ç‰¹å¾ + 32Â³å›¾åƒå—
```

### è¾“å‡ºæ•°æ®
æ¯ä¸ªç—…ä¾‹ç”Ÿæˆä¸€ä¸ª `.npz` æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- `node_features`: [N, 54] èŠ‚ç‚¹å‡ ä½•ç‰¹å¾
- `node_positions`: [N, 3] èŠ‚ç‚¹3Dåæ ‡
- `edge_index`: [2, E] å›¾è¿æ¥å…³ç³»
- `image_cubes`: [N, 32, 32, 32] èŠ‚ç‚¹å›¾åƒå—
- `node_classes`: [N] èŠ‚ç‚¹ç±»åˆ«æ ‡ç­¾ (0-17)

## ğŸ§  CPR-TaG-Netæ¨¡å‹è¯¦è§£

### æ¨¡å‹æ¶æ„
```
å›¾åƒè·¯å¾„: 3D CNN -> å…¨å±€æ± åŒ– -> æŠ•å½± [N, 256]
å›¾ç»“æ„è·¯å¾„: SA1 -> SA2 -> FP1 -> FP2 [N, 64]
èåˆåˆ†ç±»: Concat -> MLP -> åˆ†ç±» [N, 18]
```

### ç±»åˆ«å®šä¹‰ (18ç±»)
```python
0: MPA (ä¸»è‚ºåŠ¨è„‰)
1-2: LPA, RPA (å·¦å³è‚ºåŠ¨è„‰)
3-6: å·¦ä¾§äºŒçº§è¡€ç®¡ (Linternal, Lupper, Lmedium, Ldown)
7-10: å³ä¾§äºŒçº§è¡€ç®¡ (Rinternal, Rupper, Rmedium, RDown)
11-12: å·¦ä¾§ä¸‰çº§è¡€ç®¡ (L1+2, L1+3)
13-14: å³ä¾§ä¸‰çº§è¡€ç®¡ (R1+2, R1+3)
15-17: èƒŒæ™¯ã€ä¸ç¡®å®šã€è¿æ¥ç‚¹
```

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ç±»åˆ«æ•°é‡
```python
# åœ¨ train_pipeline.py ä¸­ä¿®æ”¹
parser.add_argument('--num_classes', type=int, default=18)

# åœ¨ vessel_preprocessing.py ä¸­ä¿®æ”¹ vessel_hierarchy
```

### ä¿®æ”¹ç‰¹å¾ç»´åº¦
```python
# åœ¨ vessel_preprocessing.py çš„ _compute_geometric_features ä¸­
# è°ƒæ•´ç‰¹å¾è®¡ç®—é€»è¾‘ï¼Œç¡®ä¿æ€»ç»´åº¦ä¸ºnode_feature_dim

# åœ¨ CPR_TaG_Net ä¸­ä¿®æ”¹
CPRTaGNet(node_feature_dim=54)  # æ”¹ä¸ºæ–°çš„ç‰¹å¾ç»´åº¦
```

### ä¿®æ”¹å›¾åƒå—å¤§å°
```python
# åœ¨ vessel_preprocessing.py ä¸­
VesselPreprocessor(cube_size=32)  # æ”¹ä¸ºå…¶ä»–å°ºå¯¸å¦‚64

# ç›¸åº”åœ°åœ¨CPR-TaG-Netä¸­è°ƒæ•´CNN3Dè¾“å…¥
```

## ğŸ“ˆ è®­ç»ƒç›‘æ§

### Tensorboard
```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œ
tensorboard --logdir outputs/logs
```

### æ£€æŸ¥ç‚¹
- `checkpoints/checkpoint_latest.pth`: æœ€æ–°æ¨¡å‹
- `checkpoints/checkpoint_best.pth`: æœ€ä½³éªŒè¯å‡†ç¡®ç‡æ¨¡å‹

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. å†…å­˜ä¸è¶³
```python
# å‡å°‘æ‰¹æ¬¡å¤§å°
python train_pipeline.py --batch_size 1

# å‡å°‘æœ€å¤§èŠ‚ç‚¹æ•°
# åœ¨ data_loader.py ä¸­ä¿®æ”¹ max_nodes=500
```

### 2. GPUå†…å­˜ä¸è¶³
```python
# ä½¿ç”¨CPUè®­ç»ƒï¼ˆè¾ƒæ…¢ï¼‰
# æ¨¡å‹ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨å¯ç”¨è®¾å¤‡

# æˆ–å‡å°‘å›¾åƒå—å¤§å°
VesselPreprocessor(cube_size=16)
```

### 3. æ•°æ®ä¸å¹³è¡¡
```python
# ä½¿ç”¨ç±»åˆ«æƒé‡ï¼ˆå·²è‡ªåŠ¨è®¡ç®—ï¼‰
# åœ¨ data_loader.py çš„ get_class_weights() ä¸­è°ƒæ•´ç­–ç•¥
```

## ğŸ¯ ç»“æœåˆ†æ

### è¯„ä¼°æŒ‡æ ‡
- æ•´ä½“å‡†ç¡®ç‡
- å„ç±»åˆ«ç²¾ç¡®ç‡/å¬å›ç‡
- æ··æ·†çŸ©é˜µ
- å„è¡€ç®¡ç±»å‹çš„åˆ†ç±»æ€§èƒ½

### å¯è§†åŒ–
- è¡€ç®¡å›¾ç»“æ„å¯è§†åŒ–
- é¢„æµ‹ç»“æœå¯¹æ¯”
- ç‰¹å¾ç©ºé—´åˆ†æ

## ğŸ”„ å®Œæ•´workflow

```bash
# 1. ç¡®ä¿æ•°æ®å‡†å¤‡å®Œæˆ
ls train/        # åº”è¯¥çœ‹åˆ° .nii æ–‡ä»¶
ls label_filtered/  # åº”è¯¥çœ‹åˆ° .seg.nrrd æ–‡ä»¶

# 2. è¿è¡Œæ•°æ®é¢„å¤„ç†
python train_pipeline.py --preprocess_only

# 3. æ£€æŸ¥é¢„å¤„ç†ç»“æœ
ls processed_data/  # åº”è¯¥çœ‹åˆ° _processed.npz æ–‡ä»¶

# 4. è¿è¡Œè®­ç»ƒï¼ˆå¦‚æœæœ‰PyTorchç¯å¢ƒï¼‰
python train_pipeline.py --epochs 50

# 5. ç›‘æ§è®­ç»ƒ
tensorboard --logdir outputs/logs
```

## ğŸ“ ä¸‹ä¸€æ­¥

1. **æ¨¡å‹ä¼˜åŒ–**: è°ƒæ•´ç½‘ç»œæ¶æ„ã€è¶…å‚æ•°
2. **æ•°æ®å¢å¼º**: æ›´å¤šå‡ ä½•å˜æ¢ã€å›¾åƒå¢å¼º
3. **åå¤„ç†**: è¿é€šæ€§æ£€æŸ¥ã€è§£å‰–å­¦çº¦æŸ
4. **è¯„ä¼°**: åœ¨éªŒè¯é›†ä¸Šè¯¦ç»†åˆ†æ
5. **éƒ¨ç½²**: è½¬æ¢ä¸ºæ¨ç†æ¨¡å¼ï¼Œé›†æˆåˆ°åº”ç”¨ä¸­

è¿™ä¸ªpipelineä¸ºæ‚¨æä¾›äº†ä»åŸå§‹åŒ»å­¦å›¾åƒåˆ°è¡€ç®¡åˆ†ç±»çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼
